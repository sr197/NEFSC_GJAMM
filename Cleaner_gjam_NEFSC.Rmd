---
title: "cleaner GJAM"
author: "Sarah Roberts"
date: "3/30/2019"
output: html_document
---

```{r packages, include=FALSE}
library(gjam)
library(tidyr)#data manipulation
library(dplyr) #data manipulation
library(naniar) #replace with NA
```


```{r setup, include=FALSE}
#This is the data loading chunk 

bioandcatch <- read.csv("~/Documents/ClimateOceanPlanning/Datasets/NEFSC_Bottom_Trawl/clean_neus_all.csv")
bio <- read.csv("~/Documents/ClimateOceanPlanning/Datasets/NEFSC_Bottom_Trawl/clean_neus_orig.csv")
added_vars <- read.csv("~/Documents/ClimateOceanPlanning/Datasets/NEFSC_Bottom_Trawl/clean_neus_added_vars.csv")
added_vars <- added_vars[-16616,]

bio_select <- bio %>% 
  select(haulid, station, stratum, year, season, lat, lon, datetime, depth, stemp, ssalin, btemp, bsalin, cnt, spp) %>% 
  mutate(ssalin = na_if(ssalin, 99.999))

#this command makes it so every species is a column and the values are the count of each species. This is super helpful so I don't have to use vlookup in excel.
bio_select <- bio_select %>%
  separate(haulid, into=c("ID1", "ID2", "ID3")) %>% 
  unite(ID1, ID2, ID3, col="ID", sep="") 

bio_select <- bio_select %>% 
  group_by_at(vars(-cnt)) %>%  # group by everything other than the value column. 
  mutate(row_id=1:n()) %>% ungroup() %>%  # build group index
  spread(key=spp, value=cnt)   # spread
  
y_bio_select <- bio_select %>% 
  group_by(ID) %>% 
  select(-station, -stratum, -season,  -datetime) %>% 
  select(-year, -lat, -lon, -depth, -ssalin, -stemp, -ssalin, -btemp, -bsalin, -row_id) %>% 
  replace(is.na(.), 0) %>% 
  summarise_each(funs(max)) #smooshes everything into the ID column
#up to now we have all of the y data now need to load the xdata by ID and left join so we have the whole thing. need to add a couple of variables to added vars (season etc)

#summarising some of the xdata within the original dataset NOTE_IN HERE I SHOULD SPLIT UP THE DATE_TIME THING TO GET MONTH THEN CAN ADD A COLUMN FOR SEASON
x_bio_select <- bio_select %>% 
  group_by(ID) %>% 
  select(ID, station, stratum, year, lat, lon, depth, ssalin, stemp, ssalin, btemp, bsalin, row_id)  %>% 
  summarise_each(funs(max)) #smooshes everything into the ID column

x <- added_vars %>%
  separate(haulid, into=c("ID1", "ID2", "ID3")) %>% 
  unite(ID1, ID2, ID3, col="ID", sep="") 

#joining the two 
x_y <- x %>% 
  left_join(y_bio_select, x, by="ID")

x_y <- x_y %>%
  left_join(x_bio_select, x_y,  by="ID")


###checkpoint 
#do we hav e adataset by ID with all of the x and y data as well as a dataset with just x data and just y data? 

#There are some cases where salinity and bt are 0, but that should be NA
bioandcatch <- bioandcatch %>% 
  replace_with_na_at(.vars = c("ssalin","bsalin"), condition = ~.x==0) %>%
  na_if("#DIV/0!")

#selecting y data and x data 
xdata <- bioandcatch %>% 
  select( haulid, lat, lon, year,  depth, stemp, ssalin, btemp, bsalin, Date, month, day, station, stratum,  cruise,  vessel, season,  AMO_unsm_month, AMO_unsm_year, NAO_month, NAO_year, NAO_JFM, SUBREGION2, BATHYMETRY, LPI, SLOPE, SBF_GRP, SBFDEPTH, SEDIMENT, SBFDESED)

ydata <- bioandcatch %>% 
  select(-haulid, -lat, -lon, -year, - depth, -stemp, -ssalin, -btemp, -bsalin, -Date, -month, -day, -station, -stratum, - cruise, - vessel, -season, - AMO_unsm_month, -AMO_unsm_year, -NAO_month, -NAO_year, -NAO_JFM, -SUBREGION2, -BATHYMETRY, -LPI, -SLOPE, -SBF_GRP, -SBFDEPTH, -SEDIMENT, -SBFDESED)


xdata <- bioandcatch[,1:30]
bioandcatch_trimmed <- cbind(ydata, xdata)


bioandcatch_trimmed <- as.data.frame(bioandcatch_trimmed)

#bioandcatch_trimmed$GRPSED <- as.factor(as.character(bioandcatch_trimmed$GRPSED))
bioandcatch_trimmed$SBF_GRP <- as.factor(as.character(bioandcatch_trimmed$SBF_GRP))


bioandcatch_trimmed$est_year <- as.factor(bioandcatch_trimmed$year)
bioandcatch_trimmed$AMO_unsm <- as.numeric(as.character(bioandcatch_trimmed$AMO_unsm_month))
bioandcatch_trimmed$avgdepth <- as.numeric(bioandcatch_trimmed$depth)
bioandcatch_trimmed$surfsalin <- as.numeric(bioandcatch_trimmed$ssalin)
bioandcatch_trimmed$bottemp <- as.numeric(bioandcatch_trimmed$btemp)
bioandcatch_trimmed$NAO <- as.numeric(as.character((bioandcatch_trimmed$NAO_month)))

#"ATLANTOPANDALUS.PROPINQVUS","CANCER.PLEBEJUS",  "CHACEON.QUINQUEDENS",
#need to fix this because some things are spelled incorrectly etc 
#specnames from Batt 2017
specNames <- c("ACIPENSER.OXYRYNCHUS", "ALOSA.AESTIVALIS", "ALOSA.PSEUDOHARENGUS", "ALOSA.SAPIDISSIMA", "AMBLYRAJA.RADIATA", "AMMODYTES.DUBIUS", "ANARHICHAS.LUPUS", "ANCHOA.HEPSETUS", "ANCHOA.MITCHILLI", "ANTIGONIA.CAPROS", "ARGENTINA.SILUS", "ARGENTINA.STRIATA", "ASPIDOPHOROIDES.MONOPTERYGIUS", "BAIRDIELLA.CHRYSOURA", "BATHYNECTES.LONGISPINA", "BATHYPOLYPUS.ARCTICUS", "BREVOORTIA.TYRANNUS", "BROSME.BROSME", "CANCER.BOREALIS", "CARCHARHINUS.PLUMBEUS", "CENTROPRISTIS.PHILADELPHICA", "CENTROPRISTIS.STRIATA", "CHIONOECETES.OPILIO", "CHLOROPHTHALMUS.AGASSIZI", "CITHARICHTHYS.ARCTIFRONS", "CLUPEA.HARENGUS", "CONGER.OCEANICUS", "CRANGON.SEPTEMSPINOSA", "CRYPTACANTHODES.MACULATUS", "CYCLOPTERUS.LUMPUS", "CYNOSCION.REGALIS", "DASYATIS.CENTROURA", "DASYATIS.SAY", "DECAPTERUS.PUNCTATUS", "DICHELOPANDALUS.LEPTOCERUS", "DIPTURUS.LAEVIS", "ENCHELYOPUS.CIMBRIUS", "ETROPUS.MICROSTOMUS", "ETRUMEUS.TERES", "FOETOREPUS.AGASSIZII", "GADUS.MORHUA", "GLYPTOCEPHALUS.CYNOGLOSSUS", "GYMNURA.ALTAVELA", "HELICOLENUS.DACTYLOPTERUS", "HEMITRIPTERUS.AMERICANUS", "HIPPOGLOSSINA.OBLONGA", "HIPPOGLOSSOIDES.PLATESSOIDES", "HIPPOGLOSSUS.HIPPOGLOSSUS", "HOMARUS.AMERICANUS", "ILLEX.ILLECEBROSUS", "LAGODON.RHOMBOIDES", "LARIMUS.FASCIATUS", "LEBBEUS.POLARIS", "LEIOSTOMUS.XANTHURUS", "LEPOPHIDIUM.PROFUNDORUM", "LEPTOCLINUS.MACULATUS", "LEUCORAJA.ERINACEA", "LEUCORAJA.GARMANI", "LEUCORAJA.OCELLATA", "LIMANDA.FERRUGINEA", "LIMULUS.POLYPHEMUS", "LIPARIS.ATLANTICUS", "LITHODES.MAJA", "LOLIGO.PEALEII", "LOLLIGUNCULA.BREVIS", "LOPHIUS.AMERICANUS", "LOPHOLATILUS.CHAMAELEONTICEPS", "LUMPENUS.LAMPRETAEFORMIS", "LYCENCHELYS.VERRILLII", "MACRORHAMPHOSUS.SCOLOPAX", "MALACORAJA.SENTA", "MAUROLICUS.WEITZMANI", "MELANOGRAMMUS.AEGLEFINUS", "MELANOSTIGMA.ATLANTICUM", "MENIDIA.MENIDIA", "MENTICIRRHUS.AMERICANUS", "MENTICIRRHUS.SAXATILIS", "MERLUCCIUS.ALBIDUS", "MERLUCCIUS.BILINEARIS", "MICROPOGONIAS.UNDULATUS", "MONOLENE.SESSILICAUDA", "MORONE.SAXATILIS", "MUSTELUS.CANIS", "MYLIOBATIS.FREMINVILLII", "MYOXOCEPHALUS.AENAEUS", "MYOXOCEPHALUS.OCTODECEMSPINOSUS", "MYXINE.GLUTINOSA", "NEMICHTHYS.SCOLOPACEUS", "OPHIDION.MARGINATUM", "OSMERUS.MORDAX", "OVALIPES.OCELLATUS", "OVALIPES.STEPHENSONI", "PANDALUS.BOREALIS", "PANDALUS.MONTAGUI", "PARALICHTHYS.DENTATUS", "PARASUDIS.TRUCULENTA", "PASIPHAEA.MULTIDENTATA", "PEPRILUS.TRIACANTHUS", "PERISTEDION.MINIATUM", "PETROMYZON.MARINUS")

specNames <- c("PHYCIS.CHESTERI", "PLACOPECTEN.MAGELLANICUS", "POLLACHIUS.VIRENS", "POLYMIXIA.LOWEI", "POMATOMUS.SALTATRIX", "PONTINUS.LONGISPINIS", "PONTOPHILUS.NORVEGICUS", "PRIONOTUS.ALATUS", "PRIONOTUS.CAROLINUS", "PRIONOTUS.EVOLANS", "PSEUDOPLEURONECTES.AMERICANUS", "RAJA.EGLANTERIA", "SCOMBER.SCOMBRUS", "SCOPHTHALMUS.AQUOSUS", "SCYLIORHINUS.RETIFER", "SEBASTES.FASCIATUS", "SICYONIA.BREVIROSTRIS", "SQUALUS.ACANTHIAS", "SQUATINA.DUMERIL", "STENOTOMUS.CHRYSOPS", "SYACIUM.PAPILLOSUM", "SYMPHURUS.PLAGIUSA", "SYNAGROPS.BELLUS", "SYNGNATHUS.FUSCUS", "SYNODUS.FOETENS", "SYNODUS.POEYI", "TAUTOGOLABRUS.ADSPERSUS", "TRACHINOCEPHALUS.MYOPS", "TRACHURUS.LATHAMI", "TRICHIURUS.LEPTURUS", "TRIGLOPS.MURRATRINECTES.MACULATUS", "ULVARIA.SUBBIFURCATA", "UROPHYCIS.CHUSS", "UROPHYCIS.REGIA", "UROPHYCIS.TENUIS", "ZENOPSIS.CONCHIFERA", "ZOARCES.AMERICANUS")

specNames <- c(spec1, spec2)

xnames <- c("year", "depth", "btemp", "ssalin", "AMO_unsm_month", "NAO_month", "NAO_JFM", "BATHYMETRY", "SBF_GRP", "SEDIMENT")

ydata <- bioandcatch[,specNames]
xdata <- bioandcatch[,xnames]

```

